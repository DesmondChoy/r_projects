---
title: Oil and Gas Sector 2019 (Part I)
author: Desmond Choy
date: '2019-12-19'
slug: oil-and-gas-sector-2019-part-i
categories: []
tags:
  - r
  - fixed income
  - EDA
  - visualization
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.width = 15,
  fig.height = 12)
```

While preparing for an internal sector presentation, I decided to experiment with R to see if I could replicate the results generated by Bloomberg **and** customize it further to shed more insight. The learning curve was steep but, on hindsight, I benefitted tremendously from the following:

* A great opportunity to practise all aspects of Data Science. From Importing, to Tidying, to Exploratory Data Analysis, to my first ever R Markdown document!
* To be able to use and complete a project with R in my professional field gave me an immense feeling of satisfaction.
* I wanted to customize my charts quite a fair bit and the proprietary Bloomberg terminal had its limitations. With the huge choice in R packages out there, I was able to replicate the results in Bloomberg and successfully add on more features that would provide further insight.
* Reproducible code for any other analysts that wished to use this template, so long as the sectors are labelled correctly.

This is a fairly long post, so I will be splitting it into two parts:

* Part I: Data Importing and Wrangling (Tidying)
* Part II: Exploratory Data Analysis and interpretation of results


![Workflow in a typical data science project](/img/data-science.png)
Taken from [R4DS](https://r4ds.had.co.nz/introduction.html).  

This presentation focuses on names under my Oil & Gas sector coverage. They are all investment-grade rating, and I have attempted to analyse them by [sub-sectors](https://www.schedulereader.com/blog/oil-and-gas-industry-overview) (Integrated/Independent/Midstream/Refining) as well as by credit rating buckets.

> Disclaimer

All data that I have used in this presentation is obtained from Bloomberg and I do not own any of it. Nothing in this document should be construed as investment advice, recommendations, an investment strategy, or whether or not to "buy", "sell" or "hold" an investment,  nor should it be construed or relied upon as tax, regulatory or accounting advice.

# Libraries  

```{r Libraries, warning=FALSE, message=FALSE}
library(readxl) #data importing
library(tidyverse) #data wrangling
library(magrittr) #data wrangling
library(lubridate) #date manipulation
library(hrbrthemes) #ggplot themes
library(ggrepel) #ggplot identification of data points
```

# Brief Background

Fixed income analysts regularly use the Bloomberg's SRCH <GO> screen to conduct a *Relative Value* screening of bonds i.e. holding as many parameters equal e.g. same/similar sector, credit rating, duration, credit spreads are analysed and used to determine if a bond is rich/cheap, relatively speaking. Together with fundamental analysis, this assessment on RV would then lead to an investment recommendation.  

# Importing Data  

This bond-related data is extracted from Bloomberg's SRCH. Subsequently, I learnt that Bloomberg prevented said data to be downloaded - which makes me wonder if my usage of this data prompted an internal review?  
In any case, I'm attempting to use BQL (Bloomberg Query Language) to extract similar data in future. For now, the data is available at my [github](https://github.com/DesmondChoy/glaciers/tree/master/content/post).  

```{r Importing}
Sectors <- read_xlsx("Sectors.xlsx", na = "NA")
Sectors <- Sectors[-c(1:3),]
Periods <- read_xlsx("Periods.xlsx", na = "NA")
Periods <- Periods[-c(1:3),]
Energy <- left_join(Sectors, Periods)
Energy <- distinct(Energy, CUSIP, .keep_all = TRUE)
names(Energy) <- tolower(gsub("\\s", "\\.", names(Energy))) 
```

> Examining The Data  

Pre-data wrangling, Bloomberg-extracted data will be either in character or double (numeric; double stands for double precision floating point numbers). Some data I'll require for analysis and visualiztion but are currently missing:

* Convert several of the chr columns to factors for ggplot2
* Setting factor levels for credit ratings
* Bond tickers to conveniently `group_by` 
* Days to maturity - how many days till the bond matures

`skimr` is a fantastic package used for exploratory data analysis (EDA) - identifying missing values, white spaces, and even histograms for the distribution of numeric data!

```{r skimr}
library(skimr)
skim(Energy)

```

# Tidying Data

Improving my level of understanding of how factors and levels interacted with ggplot2 was one of my learning highlights of this project.   
It was also a good opportunity to play with strings to extract information that Bloomberg didn't readily provide (or did but would require me to pull it from some other screen). 

```{r Tidying}
Energy$bloomberg.composite.rating <-
  as_factor(Energy$bloomberg.composite.rating) %>%
  factor(levels = c("AA+", "AA", "AA-", "A+", "A", "A-", "BBB+", "BBB", "BBB-", "BB+", "NR"))
Energy$ticker <- str_extract(Energy$security, "^\\w+")
Energy$year <- str_extract(Energy$security, "\\d\\d$")
Energy$coupon <- str_extract(Energy$security, "\\s.+\\s")
Energy$maturity <- as.numeric((mdy(str_extract(Energy$security, "\\d+/.+$")) - today())/365)

Energy$`moody's.rating` <- as_factor(Energy$`moody's.rating`)
Energy$`s&p.rating` <- as_factor(Energy$`s&p.rating`)
Energy$crncy <- as_factor(Energy$crncy)
Energy$bclass.level.4.classification.name <-
  as_factor(Energy$bclass.level.4.classification.name) %>%
  factor(
    levels = c(
      "Integrated",
      "Independent",
      "Midstream",
      "Refining",
      "Oil Field Services",
      "Government Owned, No Guarantee"
    )
  )
```

Firstly, I'm taking out an issuer (PAA) because it is of a significantly different credit rating (High Yield). I also took out SLB/HAL/BHI because I didn't intend to focus my presentation on Oilfield Services (another O&G sub-sector)

```{r Wrong Sectors}
Energy <- Energy %>% 
  filter(!ticker %in% c("PAA", "BHI", "SLB", "HAL"))

```

Now that I've done some initial data wrangling, I noticed there were some inconsistencies in the data e.g. CNPC, Sinopec, Petronas being labelled as Govt instead of Integrated Oil Majors (technically, there are government entities but for the purposes of analysis it'll be ideal to classify them together with other oil majors).  
STOAU was also wrongly labelled as Integrated instead of Independent, and TOPTB/VLO had different bonds tagged with different sectors.  

```{r }
Energy %>%
  filter(ticker %in% c("SINOPE", "CNPCCH", "PETMK", "PTTTB", "STOAU", "CNOOC", "TOPTB", "VLO")) %>%
  group_by(ticker, bclass.level.4.classification.name) %>% 
  summarise(n = n()) %>% 
  arrange(bclass.level.4.classification.name)

```

Doing a bit more digging as to why TOPTB and VLO had different industries tagged to them, I compared some CUSIP (bond identifiers) and ran them through Bloomberg. Turns out that different bonds were issued by different entities within the group. 

```{r Two Sectors per Ticker}
Energy %>% 
  filter(ticker %in% c("TOPTB", "VLO")) %>% 
  select(ticker, security, cusip, bclass.level.4.classification.name, bloomberg.composite.rating)
  
```

Based on the industry of the ultimate guarantor, I amended the industry classification of TOPTB and VLO accordingly.

```{r Tidying Sectors}
#Fixing "Govt" sectors, TOPTB/VLO, and STOAU
Energy$bclass.level.4.classification.name[Energy$ticker %in% c("SINOPE", "CNPCCH", "PETMK", "PTTTB")] <- "Integrated"
Energy$bclass.level.4.classification.name[Energy$ticker %in% c("CNOOC", "STOAU")] <- "Independent"
Energy$bclass.level.4.classification.name[Energy$ticker == "TOPTB"] <-
  "Refining"
Energy$bclass.level.4.classification.name[Energy$ticker == "VLO"] <-
  "Refining"
Energy$bloomberg.composite.rating[Energy$ticker == "STOAU"] <- "BBB-"
```

Now to group the companies into their respective regions. I note several of them are global companies e.g. the oil majors, so I'd admit this is a fairly arbitrary grouping that I used solely for the sake of comparison.

```{r Assigning Regions}
US <- c("CVX", "XOM", "CNQCN", "COP", "MRO", "OXY", "ENBCN", "KMI", "ETP", "MPC", "OKE")
EU <- c("BPLN", "ENIIM", "RDSALN", "TOTAL")
Asia <- c("CNOOC", "CNPCCH", "PETMK", "PTTEPT", "PTTTB", "SINOPE", "TOPTB")
AU <- c("STOAU", "WPLAU", "APAAU")
Energy$region <- if_else(Energy$ticker %in% US, "US",
                         if_else(Energy$ticker %in% EU,"EU",
                         if_else(Energy$ticker %in% Asia, "Asia",
                         "AU")))

Energy %>% 
  group_by(ticker, region) %>% 
  summarise(n = n())
```

> Comparison Metrics  

I compare the bond data across four fundamental credit metrics:  

* Leverage  
* Gearing  
* RCF/Net Debt  
* Capex/Sales 

I focus on changes in spreads over `1y.chg`(Changes in spread over the last twelve months) and `current` (Current Spread).  

> Checking For Missing Values  

We create a simple function to check for missing values as a percentage of our data in those fields.  
As we saw from our `skimr` analysis earlier, there is a fair bit of spread data missing (17%) for `1y.chg`, and I suspect this is due to bonds that were  issued within the last twelve months. I am lacking the data to verify this hypothesis (bond issuance date) so this would be something I would include the next time I perform data gathering.

```{r Checking for NAs}
#Checking for % of NAs
checkNA <- function(x) {
  sum(is.na(x)) / length(x)
}

checkNA(Energy$`1y.chg`)
checkNA(Energy$current)

```

Data wrangling for bond spread data is now complete, and we next attempt to merge this with fundamental credit metrics that is also taken from SRCH, but not from the same screen.  
I used the `pivot_longer()` function to get the data into a tidy format, and finally join it with the bond spread data.

```{r Importing fundamental data, message=FALSE}
Spreads <- Energy %>%
  group_by(bclass.level.4.classification.name,
           bloomberg.composite.rating,
           ticker,
           region) %>%
  summarise(n = n()) %>%
  select(ticker,
         bclass.level.4.classification.name,
         bloomberg.composite.rating,
         region,
         n)

#Wrangling: Credit Metrics 
Metrics <-
  excel_sheets("Credit Metrics.xlsx") %>%
  map(
    ~ read_xlsx(
      "Credit Metrics.xlsx",
      .,
      range = "L1:S27",
      na = "#N/A N/A"
    )
  )

for (i in seq(Metrics)) {
  Metrics[[i]][,2] <- NULL
}
colname <-
  c("ticker", "2014", "2015", "2016", "2017", "2018", "Jun 2019")
header <-
  c("Leverage", "Net.leverage", "Gearing", "Capex.to.sales", "CFO",
    "Capex", "Dvd", "ShareRep", "RCF.net.debt", "Int.cov")
Metrics <- map(Metrics, setNames, colname)

#This next part of code is extremely unelegant and messy... but it gets the job done
Metrics <- map2_dfc(Metrics, header, 
                    ~ pivot_longer(.x, -ticker, names_to = "Period", values_to = .y)) %>% 
  select(c(1:3, 6, 9, 12, 15, 18, 21, 24, 27, 30))

Metrics <- inner_join(Metrics, Spreads)
names(Metrics) <- tolower(gsub("\\s", "\\.", names(Metrics)))

```

> Bond Universe  

For an apples-to-apples comparison, I further narrow down my universe of bonds to:  
* Investment grade, 
* USD-denominated, 
* fixed-coupon paying bonds.

```{r Parameters}
Rating <- c("AA+", "AA", "AA-", "A+", "A", "A-", "BBB+", "BBB", "BBB-")

Energy <- Energy %>%
  filter(
      crncy == "USD" &
      bloomberg.composite.rating %in% Rating &
      coupon.type == "FIXED")
```

In the table below we see that my bond universe is skewed towards Integrated Oils, Independent and Midstream sectors.   

```{r Bond Universe}
Energy %>% 
  group_by(bclass.level.4.classification.name, ticker, bloomberg.composite.rating) %>% 
  summarise(Bonds = n()) %>% 
  knitr::kable()
```

Ok we're done tidying our data! In the next post, I'll proceed with more EDA and data visualization to identify potentially mispriced bonds.
