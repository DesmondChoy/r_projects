---
title: Oil and Gas Sector 2019 (Part I)
author: Desmond Choy
date: '2019-12-19'
slug: oil-and-gas-sector-2019-part-i
categories: []
tags:
  - r
  - fixed income
  - EDA
  - visualization
---



<p>While preparing for an internal sector presentation, I decided to experiment with R to see if I could replicate the results generated by Bloomberg <strong>and</strong> customize it further to shed more insight. The learning curve was steep but, on hindsight, I benefitted tremendously from the following:</p>
<ul>
<li>A great opportunity to practise all aspects of Data Science. From Importing, to Tidying, to Exploratory Data Analysis, to my first ever R Markdown document!</li>
<li>To be able to use and complete a project with R in my professional field gave me an immense feeling of satisfaction.</li>
<li>I wanted to customize my charts quite a fair bit and the proprietary Bloomberg terminal had its limitations. With the huge choice in R packages out there, I was able to replicate the results in Bloomberg and successfully add on more features that would provide further insight.</li>
<li>Reproducible code for any other analysts that wished to use this template, so long as the sectors are labelled correctly.</li>
</ul>
<p>This is a fairly long post, so I will be splitting it into two parts:</p>
<ul>
<li>Part I: Data Importing and Wrangling (Tidying)</li>
<li>Part II: Exploratory Data Analysis and interpretation of results</li>
</ul>
<p><img src="/img/data-science.png" alt="Workflow in a typical data science project" />
Taken from <a href="https://r4ds.had.co.nz/introduction.html">R4DS</a>.</p>
<p>This presentation focuses on names under my Oil &amp; Gas sector coverage. They are all investment-grade rating, and I have attempted to analyse them by <a href="https://www.schedulereader.com/blog/oil-and-gas-industry-overview">sub-sectors</a> (Integrated/Independent/Midstream/Refining) as well as by credit rating buckets.</p>
<blockquote>
<p>Disclaimer</p>
</blockquote>
<p>All data that I have used in this presentation is obtained from Bloomberg and I do not own any of it. Nothing in this document should be construed as investment advice, recommendations, an investment strategy, or whether or not to “buy”, “sell” or “hold” an investment, nor should it be construed or relied upon as tax, regulatory or accounting advice.</p>
<div id="libraries" class="section level1">
<h1>Libraries</h1>
<pre class="r"><code>library(readxl) #data importing
library(tidyverse) #data wrangling
library(magrittr) #data wrangling
library(lubridate) #date manipulation
library(hrbrthemes) #ggplot themes
library(ggrepel) #ggplot identification of data points</code></pre>
</div>
<div id="brief-background" class="section level1">
<h1>Brief Background</h1>
<p>Fixed income analysts regularly use the Bloomberg’s SRCH <GO> screen to conduct a <em>Relative Value</em> screening of bonds i.e. holding as many parameters equal e.g. same/similar sector, credit rating, duration, credit spreads are analysed and used to determine if a bond is rich/cheap, relatively speaking. Together with fundamental analysis, this assessment on RV would then lead to an investment recommendation.</p>
</div>
<div id="importing-data" class="section level1">
<h1>Importing Data</h1>
<p>This bond-related data is extracted from Bloomberg’s SRCH. Subsequently, I learnt that Bloomberg prevented said data to be downloaded - which makes me wonder if my usage of this data prompted an internal review?<br />
In any case, I’m attempting to use BQL (Bloomberg Query Language) to extract similar data in future. For now, the data is available at my <a href="https://github.com/DesmondChoy/glaciers/tree/master/content/post">github</a>.</p>
<pre class="r"><code>Sectors &lt;- read_xlsx(&quot;Sectors.xlsx&quot;, na = &quot;NA&quot;)
Sectors &lt;- Sectors[-c(1:3),]
Periods &lt;- read_xlsx(&quot;Periods.xlsx&quot;, na = &quot;NA&quot;)
Periods &lt;- Periods[-c(1:3),]
Energy &lt;- left_join(Sectors, Periods)
Energy &lt;- distinct(Energy, CUSIP, .keep_all = TRUE)
names(Energy) &lt;- tolower(gsub(&quot;\\s&quot;, &quot;\\.&quot;, names(Energy))) </code></pre>
<blockquote>
<p>Examining The Data</p>
</blockquote>
<p>Pre-data wrangling, Bloomberg-extracted data will be either in character or double (numeric; double stands for double precision floating point numbers). Some data I’ll require for analysis and visualiztion but are currently missing:</p>
<ul>
<li>Convert several of the chr columns to factors for ggplot2</li>
<li>Setting factor levels for credit ratings</li>
<li>Bond tickers to conveniently <code>group_by</code></li>
<li>Days to maturity - how many days till the bond matures</li>
</ul>
<p><code>skimr</code> is a fantastic package used for exploratory data analysis (EDA) - identifying missing values, white spaces, and even histograms for the distribution of numeric data!</p>
<pre class="r"><code>library(skimr)
skim(Energy)</code></pre>
<table>
<caption><span id="tab:skimr">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">Energy</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">548</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">31</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">20</td>
</tr>
<tr class="odd">
<td align="left">logical</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">numeric</td>
<td align="left">9</td>
</tr>
<tr class="odd">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">security</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">14</td>
<td align="right">21</td>
<td align="right">0</td>
<td align="right">523</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">coupon.type</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">5</td>
<td align="right">11</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">maturity.type</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">7</td>
<td align="right">11</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">next.call.date</td>
<td align="right">267</td>
<td align="right">0.51</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="right">0</td>
<td align="right">231</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">amount/issue(lcl)</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2</td>
<td align="right">8</td>
<td align="right">0</td>
<td align="right">137</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">crncy</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">moody’s.rating</td>
<td align="right">3</td>
<td align="right">0.99</td>
<td align="right">2</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">10</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">s&amp;p.rating</td>
<td align="right">3</td>
<td align="right">0.99</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">10</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">fitch.rating</td>
<td align="right">156</td>
<td align="right">0.72</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">9</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">des.notes</td>
<td align="right">379</td>
<td align="right">0.31</td>
<td align="right">1</td>
<td align="right">151</td>
<td align="right">0</td>
<td align="right">159</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">cusip</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">9</td>
<td align="right">9</td>
<td align="right">0</td>
<td align="right">548</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">benchmark</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">0</td>
<td align="right">57</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">bclass.level.1.classification.name</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">9</td>
<td align="right">18</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">bclass.level.2.classification.name</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">6</td>
<td align="right">10</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">bclass.level.3.classification.name</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">6</td>
<td align="right">30</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">bclass.level.4.classification.name</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">8</td>
<td align="right">30</td>
<td align="right">0</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">fitch.outlook</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">moody.outlook</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">s&amp;p.outlook</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">bloomberg.composite.rating</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">11</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: logical</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="left">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1d.chg</td>
<td align="right">548</td>
<td align="right">0</td>
<td align="right">NaN</td>
<td align="left">:</td>
</tr>
<tr class="even">
<td align="left">mtd.chg</td>
<td align="right">548</td>
<td align="right">0</td>
<td align="right">NaN</td>
<td align="left">:</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">next.call.price</td>
<td align="right">269</td>
<td align="right">0.51</td>
<td align="right">100.01</td>
<td align="right">0.08</td>
<td align="right">100.00</td>
<td align="right">100.00</td>
<td align="right">100.00</td>
<td align="right">100.00</td>
<td align="right">100.90</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">current</td>
<td align="right">1</td>
<td align="right">1.00</td>
<td align="right">127.68</td>
<td align="right">83.25</td>
<td align="right">-476.55</td>
<td align="right">70.08</td>
<td align="right">107.51</td>
<td align="right">173.73</td>
<td align="right">430.66</td>
<td align="left">▁▁▃▇▁</td>
</tr>
<tr class="odd">
<td align="left">1w.chg</td>
<td align="right">11</td>
<td align="right">0.98</td>
<td align="right">1.60</td>
<td align="right">6.62</td>
<td align="right">-20.10</td>
<td align="right">-1.60</td>
<td align="right">0.70</td>
<td align="right">3.90</td>
<td align="right">78.20</td>
<td align="left">▆▇▁▁▁</td>
</tr>
<tr class="even">
<td align="left">1m.chg</td>
<td align="right">6</td>
<td align="right">0.99</td>
<td align="right">-3.25</td>
<td align="right">8.96</td>
<td align="right">-39.80</td>
<td align="right">-7.80</td>
<td align="right">-3.40</td>
<td align="right">1.17</td>
<td align="right">76.50</td>
<td align="left">▁▇▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">3m.chg</td>
<td align="right">44</td>
<td align="right">0.92</td>
<td align="right">4.70</td>
<td align="right">13.36</td>
<td align="right">-55.30</td>
<td align="right">-3.65</td>
<td align="right">3.10</td>
<td align="right">10.50</td>
<td align="right">106.50</td>
<td align="left">▁▇▃▁▁</td>
</tr>
<tr class="even">
<td align="left">1y.chg</td>
<td align="right">92</td>
<td align="right">0.83</td>
<td align="right">-5.54</td>
<td align="right">28.17</td>
<td align="right">-174.00</td>
<td align="right">-20.90</td>
<td align="right">-10.95</td>
<td align="right">5.82</td>
<td align="right">111.40</td>
<td align="left">▁▁▇▃▁</td>
</tr>
<tr class="odd">
<td align="left">qtd.chg</td>
<td align="right">10</td>
<td align="right">0.98</td>
<td align="right">-2.98</td>
<td align="right">10.06</td>
<td align="right">-65.00</td>
<td align="right">-7.80</td>
<td align="right">-3.00</td>
<td align="right">2.20</td>
<td align="right">83.90</td>
<td align="left">▁▅▇▁▁</td>
</tr>
<tr class="even">
<td align="left">ytd.chg</td>
<td align="right">4</td>
<td align="right">0.99</td>
<td align="right">-37.75</td>
<td align="right">29.55</td>
<td align="right">-149.80</td>
<td align="right">-56.73</td>
<td align="right">-37.25</td>
<td align="right">-19.03</td>
<td align="right">76.00</td>
<td align="left">▁▃▇▃▁</td>
</tr>
<tr class="odd">
<td align="left">cust.chg</td>
<td align="right">171</td>
<td align="right">0.69</td>
<td align="right">-39.23</td>
<td align="right">25.55</td>
<td align="right">-143.80</td>
<td align="right">-50.60</td>
<td align="right">-36.70</td>
<td align="right">-24.20</td>
<td align="right">78.80</td>
<td align="left">▁▂▇▁▁</td>
</tr>
</tbody>
</table>
</div>
<div id="tidying-data" class="section level1">
<h1>Tidying Data</h1>
<p>Improving my level of understanding of how factors and levels interacted with ggplot2 was one of my learning highlights of this project.<br />
It was also a good opportunity to play with strings to extract information that Bloomberg didn’t readily provide (or did but would require me to pull it from some other screen).</p>
<pre class="r"><code>Energy$bloomberg.composite.rating &lt;-
  as_factor(Energy$bloomberg.composite.rating) %&gt;%
  factor(levels = c(&quot;AA+&quot;, &quot;AA&quot;, &quot;AA-&quot;, &quot;A+&quot;, &quot;A&quot;, &quot;A-&quot;, &quot;BBB+&quot;, &quot;BBB&quot;, &quot;BBB-&quot;, &quot;BB+&quot;, &quot;NR&quot;))
Energy$ticker &lt;- str_extract(Energy$security, &quot;^\\w+&quot;)
Energy$year &lt;- str_extract(Energy$security, &quot;\\d\\d$&quot;)
Energy$coupon &lt;- str_extract(Energy$security, &quot;\\s.+\\s&quot;)
Energy$maturity &lt;- as.numeric((mdy(str_extract(Energy$security, &quot;\\d+/.+$&quot;)) - today())/365)

Energy$`moody&#39;s.rating` &lt;- as_factor(Energy$`moody&#39;s.rating`)
Energy$`s&amp;p.rating` &lt;- as_factor(Energy$`s&amp;p.rating`)
Energy$crncy &lt;- as_factor(Energy$crncy)
Energy$bclass.level.4.classification.name &lt;-
  as_factor(Energy$bclass.level.4.classification.name) %&gt;%
  factor(
    levels = c(
      &quot;Integrated&quot;,
      &quot;Independent&quot;,
      &quot;Midstream&quot;,
      &quot;Refining&quot;,
      &quot;Oil Field Services&quot;,
      &quot;Government Owned, No Guarantee&quot;
    )
  )</code></pre>
<p>Firstly, I’m taking out an issuer (PAA) because it is of a significantly different credit rating (High Yield). I also took out SLB/HAL/BHI because I didn’t intend to focus my presentation on Oilfield Services (another O&amp;G sub-sector)</p>
<pre class="r"><code>Energy &lt;- Energy %&gt;% 
  filter(!ticker %in% c(&quot;PAA&quot;, &quot;BHI&quot;, &quot;SLB&quot;, &quot;HAL&quot;))</code></pre>
<p>Now that I’ve done some initial data wrangling, I noticed there were some inconsistencies in the data e.g. CNPC, Sinopec, Petronas being labelled as Govt instead of Integrated Oil Majors (technically, there are government entities but for the purposes of analysis it’ll be ideal to classify them together with other oil majors).<br />
STOAU was also wrongly labelled as Integrated instead of Independent, and TOPTB/VLO had different bonds tagged with different sectors.</p>
<pre class="r"><code>Energy %&gt;%
  filter(ticker %in% c(&quot;SINOPE&quot;, &quot;CNPCCH&quot;, &quot;PETMK&quot;, &quot;PTTTB&quot;, &quot;STOAU&quot;, &quot;CNOOC&quot;, &quot;TOPTB&quot;, &quot;VLO&quot;)) %&gt;%
  group_by(ticker, bclass.level.4.classification.name) %&gt;% 
  summarise(n = n()) %&gt;% 
  arrange(bclass.level.4.classification.name)</code></pre>
<pre><code>## # A tibble: 10 x 3
## # Groups:   ticker [8]
##    ticker bclass.level.4.classification.name     n
##    &lt;chr&gt;  &lt;fct&gt;                              &lt;int&gt;
##  1 STOAU  Integrated                             2
##  2 VLO    Midstream                              2
##  3 TOPTB  Refining                               5
##  4 VLO    Refining                               8
##  5 TOPTB  Oil Field Services                     2
##  6 CNOOC  Government Owned, No Guarantee        20
##  7 CNPCCH Government Owned, No Guarantee         4
##  8 PETMK  Government Owned, No Guarantee         5
##  9 PTTTB  Government Owned, No Guarantee         3
## 10 SINOPE Government Owned, No Guarantee        26</code></pre>
<p>Doing a bit more digging as to why TOPTB and VLO had different industries tagged to them, I compared some CUSIP (bond identifiers) and ran them through Bloomberg. Turns out that different bonds were issued by different entities within the group.</p>
<pre class="r"><code>Energy %&gt;% 
  filter(ticker %in% c(&quot;TOPTB&quot;, &quot;VLO&quot;)) %&gt;% 
  select(ticker, security, cusip, bclass.level.4.classification.name, bloomberg.composite.rating)</code></pre>
<pre><code>## # A tibble: 17 x 5
##    ticker security       cusip   bclass.level.4.classific~ bloomberg.composite.~
##    &lt;chr&gt;  &lt;chr&gt;          &lt;chr&gt;   &lt;fct&gt;                     &lt;fct&gt;                
##  1 TOPTB  TOPTB 3 &lt;U+215D&gt; 01/~ 88323A~ Refining                  BBB+                 
##  2 TOPTB  TOPTB 3 &lt;U+215D&gt; 01/~ EJ5222~ Oil Field Services        BBB+                 
##  3 VLO    VLO 3.65 03/1~ 91913Y~ Refining                  BBB                  
##  4 VLO    VLO 3.4 09/15~ 91913Y~ Refining                  BBB                  
##  5 VLO    VLO 4 &lt;U+215C&gt; 12/15~ 91914J~ Midstream                 BBB                  
##  6 VLO    VLO 4 ½ 03/15~ 91914J~ Midstream                 BBB                  
##  7 VLO    VLO 4.35 06/0~ 91913Y~ Refining                  BBB                  
##  8 TOPTB  TOPTB 4 &lt;U+215D&gt; 11/~ 88323A~ Refining                  BBB+                 
##  9 VLO    VLO 4 04/01/29 91913Y~ Refining                  BBB                  
## 10 VLO    VLO 7 ½ 04/15~ 91913Y~ Refining                  BBB                  
## 11 VLO    VLO 6 &lt;U+215D&gt; 06/15~ 91913Y~ Refining                  BBB                  
## 12 VLO    VLO 10 ½ 03/1~ 91913Y~ Refining                  BBB                  
## 13 TOPTB  TOPTB 4 &lt;U+215E&gt; 01/~ EJ5222~ Oil Field Services        BBB+                 
## 14 TOPTB  TOPTB 4 &lt;U+215E&gt; 01/~ 88323A~ Refining                  BBB+                 
## 15 VLO    VLO 4.9 03/15~ 91913Y~ Refining                  BBB                  
## 16 TOPTB  TOPTB 5 &lt;U+215C&gt; 11/~ 88323A~ Refining                  BBB+                 
## 17 TOPTB  TOPTB 3 ½ 10/~ 88323A~ Refining                  BBB+</code></pre>
<p>Based on the industry of the ultimate guarantor, I amended the industry classification of TOPTB and VLO accordingly.</p>
<pre class="r"><code>#Fixing &quot;Govt&quot; sectors, TOPTB/VLO, and STOAU
Energy$bclass.level.4.classification.name[Energy$ticker %in% c(&quot;SINOPE&quot;, &quot;CNPCCH&quot;, &quot;PETMK&quot;, &quot;PTTTB&quot;)] &lt;- &quot;Integrated&quot;
Energy$bclass.level.4.classification.name[Energy$ticker %in% c(&quot;CNOOC&quot;, &quot;STOAU&quot;)] &lt;- &quot;Independent&quot;
Energy$bclass.level.4.classification.name[Energy$ticker == &quot;TOPTB&quot;] &lt;-
  &quot;Refining&quot;
Energy$bclass.level.4.classification.name[Energy$ticker == &quot;VLO&quot;] &lt;-
  &quot;Refining&quot;
Energy$bloomberg.composite.rating[Energy$ticker == &quot;STOAU&quot;] &lt;- &quot;BBB-&quot;</code></pre>
<p>Now to group the companies into their respective regions. I note several of them are global companies e.g. the oil majors, so I’d admit this is a fairly arbitrary grouping that I used solely for the sake of comparison.</p>
<pre class="r"><code>US &lt;- c(&quot;CVX&quot;, &quot;XOM&quot;, &quot;CNQCN&quot;, &quot;COP&quot;, &quot;MRO&quot;, &quot;OXY&quot;, &quot;ENBCN&quot;, &quot;KMI&quot;, &quot;ETP&quot;, &quot;MPC&quot;, &quot;OKE&quot;)
EU &lt;- c(&quot;BPLN&quot;, &quot;ENIIM&quot;, &quot;RDSALN&quot;, &quot;TOTAL&quot;)
Asia &lt;- c(&quot;CNOOC&quot;, &quot;CNPCCH&quot;, &quot;PETMK&quot;, &quot;PTTEPT&quot;, &quot;PTTTB&quot;, &quot;SINOPE&quot;, &quot;TOPTB&quot;)
AU &lt;- c(&quot;STOAU&quot;, &quot;WPLAU&quot;, &quot;APAAU&quot;)
Energy$region &lt;- if_else(Energy$ticker %in% US, &quot;US&quot;,
                         if_else(Energy$ticker %in% EU,&quot;EU&quot;,
                         if_else(Energy$ticker %in% Asia, &quot;Asia&quot;,
                         &quot;AU&quot;)))

Energy %&gt;% 
  group_by(ticker, region) %&gt;% 
  summarise(n = n())</code></pre>
<pre><code>## # A tibble: 26 x 3
## # Groups:   ticker [26]
##    ticker region     n
##    &lt;chr&gt;  &lt;chr&gt;  &lt;int&gt;
##  1 APAAU  AU         9
##  2 BPLN   EU        62
##  3 CNOOC  Asia      20
##  4 CNPCCH Asia       4
##  5 CNQCN  US        15
##  6 COP    US        19
##  7 CVX    US        10
##  8 ENBCN  US        26
##  9 ENIIM  EU        18
## 10 ETP    US        49
## # ... with 16 more rows</code></pre>
<blockquote>
<p>Comparison Metrics</p>
</blockquote>
<p>I compare the bond data across four fundamental credit metrics:</p>
<ul>
<li>Leverage<br />
</li>
<li>Gearing<br />
</li>
<li>RCF/Net Debt<br />
</li>
<li>Capex/Sales</li>
</ul>
<p>I focus on changes in spreads over <code>1y.chg</code>(Changes in spread over the last twelve months) and <code>current</code> (Current Spread).</p>
<blockquote>
<p>Checking For Missing Values</p>
</blockquote>
<p>We create a simple function to check for missing values as a percentage of our data in those fields.<br />
As we saw from our <code>skimr</code> analysis earlier, there is a fair bit of spread data missing (17%) for <code>1y.chg</code>, and I suspect this is due to bonds that were issued within the last twelve months. I am lacking the data to verify this hypothesis (bond issuance date) so this would be something I would include the next time I perform data gathering.</p>
<pre class="r"><code>#Checking for % of NAs
checkNA &lt;- function(x) {
  sum(is.na(x)) / length(x)
}

checkNA(Energy$`1y.chg`)</code></pre>
<pre><code>## [1] 0.166</code></pre>
<pre class="r"><code>checkNA(Energy$current)</code></pre>
<pre><code>## [1] 0.002</code></pre>
<p>Data wrangling for bond spread data is now complete, and we next attempt to merge this with fundamental credit metrics that is also taken from SRCH, but not from the same screen.<br />
I used the <code>pivot_longer()</code> function to get the data into a tidy format, and finally join it with the bond spread data.</p>
<pre class="r"><code>Spreads &lt;- Energy %&gt;%
  group_by(bclass.level.4.classification.name,
           bloomberg.composite.rating,
           ticker,
           region) %&gt;%
  summarise(n = n()) %&gt;%
  select(ticker,
         bclass.level.4.classification.name,
         bloomberg.composite.rating,
         region,
         n)

#Wrangling: Credit Metrics 
Metrics &lt;-
  excel_sheets(&quot;Credit Metrics.xlsx&quot;) %&gt;%
  map(
    ~ read_xlsx(
      &quot;Credit Metrics.xlsx&quot;,
      .,
      range = &quot;L1:S27&quot;,
      na = &quot;#N/A N/A&quot;
    )
  )

for (i in seq(Metrics)) {
  Metrics[[i]][,2] &lt;- NULL
}
colname &lt;-
  c(&quot;ticker&quot;, &quot;2014&quot;, &quot;2015&quot;, &quot;2016&quot;, &quot;2017&quot;, &quot;2018&quot;, &quot;Jun 2019&quot;)
header &lt;-
  c(&quot;Leverage&quot;, &quot;Net.leverage&quot;, &quot;Gearing&quot;, &quot;Capex.to.sales&quot;, &quot;CFO&quot;,
    &quot;Capex&quot;, &quot;Dvd&quot;, &quot;ShareRep&quot;, &quot;RCF.net.debt&quot;, &quot;Int.cov&quot;)
Metrics &lt;- map(Metrics, setNames, colname)

#This next part of code is extremely unelegant and messy... but it gets the job done
Metrics &lt;- map2_dfc(Metrics, header, 
                    ~ pivot_longer(.x, -ticker, names_to = &quot;Period&quot;, values_to = .y)) %&gt;% 
  select(c(1:3, 6, 9, 12, 15, 18, 21, 24, 27, 30))

Metrics &lt;- inner_join(Metrics, Spreads)
names(Metrics) &lt;- tolower(gsub(&quot;\\s&quot;, &quot;\\.&quot;, names(Metrics)))</code></pre>
<blockquote>
<p>Bond Universe</p>
</blockquote>
<p>For an apples-to-apples comparison, I further narrow down my universe of bonds to:<br />
* Investment grade,
* USD-denominated,
* fixed-coupon paying bonds.</p>
<pre class="r"><code>Rating &lt;- c(&quot;AA+&quot;, &quot;AA&quot;, &quot;AA-&quot;, &quot;A+&quot;, &quot;A&quot;, &quot;A-&quot;, &quot;BBB+&quot;, &quot;BBB&quot;, &quot;BBB-&quot;)

Energy &lt;- Energy %&gt;%
  filter(
      crncy == &quot;USD&quot; &amp;
      bloomberg.composite.rating %in% Rating &amp;
      coupon.type == &quot;FIXED&quot;)</code></pre>
<p>In the table below we see that my bond universe is skewed towards Integrated Oils, Independent and Midstream sectors.</p>
<pre class="r"><code>Energy %&gt;% 
  group_by(bclass.level.4.classification.name, ticker, bloomberg.composite.rating) %&gt;% 
  summarise(Bonds = n()) %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">bclass.level.4.classification.name</th>
<th align="left">ticker</th>
<th align="left">bloomberg.composite.rating</th>
<th align="right">Bonds</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Integrated</td>
<td align="left">BPLN</td>
<td align="left">A</td>
<td align="right">40</td>
</tr>
<tr class="even">
<td align="left">Integrated</td>
<td align="left">CNPCCH</td>
<td align="left">A</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Integrated</td>
<td align="left">CVX</td>
<td align="left">AA</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">Integrated</td>
<td align="left">ENIIM</td>
<td align="left">BBB+</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Integrated</td>
<td align="left">PETMK</td>
<td align="left">A-</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">Integrated</td>
<td align="left">PTTTB</td>
<td align="left">BBB+</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Integrated</td>
<td align="left">RDSALN</td>
<td align="left">AA-</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">Integrated</td>
<td align="left">SINOPE</td>
<td align="left">A+</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="left">Integrated</td>
<td align="left">TOTAL</td>
<td align="left">A+</td>
<td align="right">14</td>
</tr>
<tr class="even">
<td align="left">Integrated</td>
<td align="left">XOM</td>
<td align="left">AA+</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">Independent</td>
<td align="left">CNOOC</td>
<td align="left">A+</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="left">Independent</td>
<td align="left">CNQCN</td>
<td align="left">BBB</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">Independent</td>
<td align="left">COP</td>
<td align="left">A-</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="left">Independent</td>
<td align="left">MRO</td>
<td align="left">BBB-</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">Independent</td>
<td align="left">OXY</td>
<td align="left">BBB</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="left">Independent</td>
<td align="left">PTTEPT</td>
<td align="left">BBB+</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Independent</td>
<td align="left">STOAU</td>
<td align="left">BBB-</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Independent</td>
<td align="left">WPLAU</td>
<td align="left">BBB+</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">Midstream</td>
<td align="left">APAAU</td>
<td align="left">BBB</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">Midstream</td>
<td align="left">ENBCN</td>
<td align="left">BBB</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">Midstream</td>
<td align="left">ETP</td>
<td align="left">BBB-</td>
<td align="right">49</td>
</tr>
<tr class="even">
<td align="left">Midstream</td>
<td align="left">KMI</td>
<td align="left">BBB</td>
<td align="right">46</td>
</tr>
<tr class="odd">
<td align="left">Midstream</td>
<td align="left">OKE</td>
<td align="left">BBB-</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">Refining</td>
<td align="left">MPC</td>
<td align="left">BBB</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="left">Refining</td>
<td align="left">TOPTB</td>
<td align="left">BBB+</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Refining</td>
<td align="left">VLO</td>
<td align="left">BBB</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
<p>Ok we’re done tidying our data! In the next post, I’ll proceed with more EDA and data visualization to identify potentially mispriced bonds.</p>
</div>
